---
marp: true
theme: default
size: 16:9
paginate: true
headingDivider: 2
backgroundImage: url('https://marp.app/assets/hero-background.svg')
---

# SQLアンチパターン  <br> 第III部：クエリのアンチパターン

<!-- --- -->

## 第13章：フィア・オブ・ジ・アンノウン

### 🎯 目的
欠けている値を適切に扱う

### ⚠️ アンチパターン
NULLを一般値として使う or 一般値をNULLとして使う

- NULLと比較すると意図通りに動かない
- ロジックが破綻しやすい

---

### ✅ 13章解決策
NULLは特別な値として扱う

- `IS NULL`を使う
- NOT NULL制約を使う
- 動的デフォルトで回避

<!-- --- -->

## 第14章：アンビギュアスグループ（曖昧なグループ）

### 🎯 目的
グループ内で最大値を持つ行を取得

### ⚠️ アンチパターン
非グループ化列をSELECTで使う

- GROUP BYと集約の意味が曖昧になる
- 期待しない行が選ばれる

### ✅ 解決策
相関サブクエリやJOINで明示的に書く  
→ 関数従属性を満たす列のみを使う

<!-- --- -->

## 第15章：ランダムセレクション

### 🎯 目的
サンプル行をランダムに取得

### ⚠️ アンチパターン
`ORDER BY RANDOM()`（全件シャッフル）

- 大量データで極端に遅い

### ✅ 解決策
- ランダムなID選出
- オフセット指定
- インデックス活用
- 実装言語側でシャッフル

<!-- --- -->

## 第16章：プアマンズ・サーチエンジン

### 🎯 目的
全文検索を実装

### ⚠️ アンチパターン
`LIKE '%キーワード%'` で検索

- 遅い
- スケールしない
- インデックスが効かない

---

### ✅ 16章解決策
専用の全文検索機能を使う

- PostgreSQL: `tsvector`, `tsquery`
- SQLite: `FTS`
- 外部エンジン：Elasticsearch など

<!-- --- -->

## 第17章：スパゲッティクエリ

### 🎯 目的
SQLクエリ数を減らす

### ⚠️ アンチパターン
1クエリですべて解決しようとする

- 可読性低下
- デバッグ困難

### ✅ 解決策
クエリを分割して処理

- ビューやCTEで分割
- `UNION`, `CASE`, `JOIN`の適切な利用

<!-- --- -->

## 第18章：インプリシットカラム

### 🎯 目的
記述量を減らす

### ⚠️ アンチパターン
`SELECT *`の多用（暗黙の列指定）

- 将来的な変更で壊れる
- 意図しないカラムの取得

---

### ✅ 18章解決策
明示的にカラム名を書く

- YAGNIを意識
- テストしやすくなる
- 意図が明確になる

<!-- --- -->

## 🧪 ハンズオンのヒント

- `NULL`を含む列でのフィルタ実験
- `GROUP BY` vs 相関サブクエリの動作比較
- `ORDER BY RANDOM()` vs ランダムID選択
- `LIKE`検索と`to_tsvector()`の速度比較
- `SELECT *`を使った時の事故体験

<!-- --- -->

## 🚀 次回予告

次は**第IV部：アプリケーション開発のアンチパターン**  
セキュリティや設計思想に踏み込みます！

