---
marp: true
theme: default
size: 16:9
paginate: true
headingDivider: 2
backgroundImage: url('https://marp.app/assets/hero-background.svg')
---

<!-- I部 データベース論理設計のアンチパターン -->

# SQLアンチパターン<br> I部 データベース論理設計のアンチパターン

<!-- --- -->
## 第1章 ジェイウォーク（信号無視）
- **目的**: 複数の値を持つ属性を格納する
- **アンチパターン**: カンマ区切りでリストを格納する
- **問題点**:
  - 検索・更新・検証が困難

<!-- --- -->

## 多vs多の状況ってあるある……
`product`データに担当者を一人つけている<br>
  → これを複数人対応させたい。(社内、社外もろもろ……)

<!-- --- -->

## 1-1 多vs多の構成 ~アンチパターン~
カンマ区切りで複数データを管理する
```sql
CREATE TABLE Products (
  product_id   SERIAL PRIMARY KEY,
  product_name VARCHAR(1000),
  account_id   VARCHAR(100), -- カンマ区切りのリスト
  -- 他の列. . .
);

INSERT INTO Products (product_id, product_name, account_id)
VALUES (DEFAULT, 'Visual TurboBuilder', '12,34');
```
<!-- --- -->

##  1-1 多vs多の構成 ~アンチパターンへのツッコミ~
* 外からクエリでいじると死ぬ(1-2-1~3,5)
    * `WHERE`, `JOIN`, `sum()`などの集約関数,値の検証などなど……
* `acount_id`のUPDATEで死ぬ (1-2-4)
* 区切り文字は当該データ内で本当に使用されないか(1-2-6)
* 設定された長さは問題ないか(1-2-7)

<!-- --- -->

## 1-1 具体例



<!-- --- -->

## 第2章 ナイーブツリー（素朴な木）
- **目的**: 階層構造の格納
- **アンチパターン**: 隣接リストのみを使用
- **解決策**:
  - 経路列挙
  - 入れ子集合
  - 閉包テーブル

<!-- --- -->

## 第3章 IDリクワイアド（とりあえずID）
- **目的**: 主キーの規約確立
- **アンチパターン**: 全てのテーブルにid列
- **解決策**: 状況に応じて自然キーや複合キーを検討

<!-- --- -->

## 第4章 キーレスエントリ（外部キー嫌い）
- **目的**: DBアーキテクチャの単純化
- **アンチパターン**: 外部キー制約を使わない
- **解決策**: 外部キー制約を宣言して整合性確保

<!-- --- -->

## 第5章 EAV（エンティティ・アトリビュート・バリュー）
- **目的**: 可変属性のサポート
- **アンチパターン**: 汎用属性テーブルの使用
- **解決策**:
  - 継承パターンの利用
  - サブタイプのモデリング

<!-- --- -->

## 第6章 ポリモーフィック関連
- **目的**: 複数の親テーブル参照
- **アンチパターン**: 二重目的の外部キー
- **解決策**:
  - リファレンス逆転
  - 交差テーブル
  - 共通親テーブル

<!-- --- -->

## 第7章 マルチカラムアトリビュート（複数列属性）
- **目的**: 複数値の属性格納
- **アンチパターン**: 複数列を定義
- **解決策**: 従属テーブルの作成

<!-- --- -->

## 第8章 メタデータトリブル（メタデータ大増殖）
- **目的**: スケーラビリティの向上
- **アンチパターン**: テーブルや列の複製
- **解決策**:
  - パーティショニング
  - 正規化

<!-- --- -->

## 次回: II部 データベース物理設計のアンチパターン
- 浮動小数点誤差
- 値の列定義の固定化
- メディアファイル保存の誤り


